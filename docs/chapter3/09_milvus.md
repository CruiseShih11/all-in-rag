# ç¬¬å››èŠ‚ Milvusä»‹ç»åŠå¤šæ¨¡æ€æ£€ç´¢å®è·µ

## ä¸€ã€ç®€ä»‹

Milvus æ˜¯ä¸€ä¸ªå¼€æºçš„ã€ä¸“ä¸ºå¤§è§„æ¨¡å‘é‡ç›¸ä¼¼æ€§æœç´¢å’Œåˆ†æè€Œè®¾è®¡çš„å‘é‡æ•°æ®åº“ã€‚å®ƒè¯ç”Ÿäº Zilliz å…¬å¸ï¼Œå¹¶å·²æˆä¸º LF AI & Data åŸºé‡‘ä¼šçš„é¡¶çº§é¡¹ç›®ï¼Œåœ¨AIé¢†åŸŸæ‹¥æœ‰å¹¿æ³›çš„åº”ç”¨ã€‚

ä¸ FAISSã€ChromaDB ç­‰è½»é‡çº§æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆä¸åŒï¼ŒMilvus ä»è®¾è®¡ä¹‹åˆå°±ç„å‡†äº†**ç”Ÿäº§ç¯å¢ƒ**ã€‚å…¶é‡‡ç”¨äº‘åŸç”Ÿæ¶æ„ï¼Œå…·å¤‡é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€æ˜“æ‰©å±•çš„ç‰¹æ€§ï¼Œèƒ½å¤Ÿå¤„ç†åäº¿ã€ç™¾äº¿ç”šè‡³æ›´å¤§è§„æ¨¡çš„å‘é‡æ•°æ®ã€‚

**å®˜ç½‘åœ°å€**: [https://milvus.io/](https://milvus.io/)

**GitHub**: [https://github.com/milvus-io/milvus](https://github.com/milvus-io/milvus)

## äºŒã€ éƒ¨ç½²å®‰è£…

Milvus æä¾›äº†å¤šç§éƒ¨ç½²æ–¹å¼ï¼Œè¿™é‡Œä»¥ **Milvus Standalone (å•æœºç‰ˆ)** ä¸ºä¾‹ã€‚

### 1. ç¯å¢ƒå‡†å¤‡

- **å®‰è£… Docker ä¸ Docker Compose**: ç¡®ä¿ç³»ç»Ÿä¸­å·²å®‰è£…å¹¶æ­£åœ¨è¿è¡Œ Docker å’Œ Docker Composeã€‚å¦‚æœä½ å¯¹ Docker ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡è¯¦ç»†çš„æ•™ç¨‹ï¼š[Docker ä¸‡å­—æ•™ç¨‹ï¼šä»å…¥é—¨åˆ°æŒæ¡](https://mp.weixin.qq.com/s/u2es87JU5FNlGo3qDLY_ng)ã€‚

> codespace ç¯å¢ƒè‡ªå¸¦Docker Composeæ— éœ€å®‰è£…

### 2. ä¸‹è½½å¹¶å¯åŠ¨ Milvus

åœ¨ä½ é€‰å®šçš„å·¥ä½œç›®å½•ä¸‹ï¼Œæ‰“å¼€ç»ˆç«¯ï¼ˆTerminalï¼‰æˆ–å‘½ä»¤è¡Œå·¥å…·ï¼ˆPowerShellï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

**ç¬¬ä¸€æ­¥ï¼šä¸‹è½½é…ç½®æ–‡ä»¶**

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½å®˜æ–¹çš„ `docker-compose.yml` æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº† Milvus Standalone åŠå…¶è¿è¡Œæ‰€éœ€çš„ä¸¤ä¸ªæ ¸å¿ƒä¾èµ–æœåŠ¡ï¼š`etcd` ç”¨äºå­˜å‚¨å…ƒæ•°æ®ï¼Œ`MinIO` ç”¨äºå¯¹è±¡å­˜å‚¨ï¼ˆæ›´å¤šæ¶æ„ç»†èŠ‚è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://milvus.io/docs/architecture_overview.md)ï¼‰ã€‚

```bash
# macOS / Linux (ä½¿ç”¨ wget)
wget https://github.com/milvus-io/milvus/releases/download/v2.5.14/milvus-standalone-docker-compose.yml -O docker-compose.yml
```

```powershell
# Windows (ä½¿ç”¨ PowerShell)
Invoke-WebRequest -Uri "https://github.com/milvus-io/milvus/releases/download/v2.5.14/milvus-standalone-docker-compose.yml" -OutFile "docker-compose.yml"
```

**ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Milvus æœåŠ¡**

åœ¨ `docker-compose.yml` æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åå°æ¨¡å¼å¯åŠ¨ Milvusï¼š

```bash
docker compose up -d
```

Docker å°†ä¼šè‡ªåŠ¨æ‹‰å–æ‰€éœ€çš„é•œåƒå¹¶å¯åŠ¨ä¸‰ä¸ªå®¹å™¨ï¼š`milvus-standalone`, `milvus-minio`, å’Œ `milvus-etcd`ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œå…·ä½“å–å†³äºä½ çš„ç½‘ç»œçŠ¶å†µã€‚

### 3. éªŒè¯å®‰è£…

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ Milvus æ˜¯å¦æˆåŠŸå¯åŠ¨ï¼š

- **æŸ¥çœ‹ Docker å®¹å™¨**: æ‰“å¼€ Docker Desktop çš„ä»ªè¡¨ç›˜ (Windows/macOS) æˆ–åœ¨ç»ˆç«¯è¿è¡Œ `docker ps` å‘½ä»¤ (Linux)ï¼Œç¡®è®¤ä¸‰ä¸ª Milvus ç›¸å…³å®¹å™¨ï¼ˆ`milvus-standalone`, `milvus-minio`, `milvus-etcd`ï¼‰éƒ½å¤„äº `running` æˆ– `up` çŠ¶æ€ã€‚
- **æ£€æŸ¥æœåŠ¡ç«¯å£**: Milvus Standalone é»˜è®¤é€šè¿‡ `19530` ç«¯å£æä¾›æœåŠ¡ï¼Œè¿™æ˜¯åç»­ä»£ç è¿æ¥æ—¶éœ€è¦ç”¨åˆ°çš„åœ°å€ã€‚

### 4. å¸¸ç”¨ç®¡ç†å‘½ä»¤

- **åœæ­¢æœåŠ¡**:
  ```bash
  docker compose down
  ```
  æ­¤å‘½ä»¤ä¼šåœæ­¢å¹¶ç§»é™¤å®¹å™¨ï¼Œä½†ä¿ç•™å­˜å‚¨çš„æ•°æ®å·ã€‚

- **å½»åº•æ¸…ç† (åœæ­¢å¹¶åˆ é™¤æ•°æ®)**:
  å¦‚æœæƒ³å½»åº•åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å‘é‡ã€å…ƒæ•°æ®ç­‰ï¼‰ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
  ```bash
  docker compose down -v
  ```

## ä¸‰ã€æ ¸å¿ƒç»„ä»¶

### 3.1 Collection (é›†åˆ)

å¯ä»¥ç”¨ä¸€ä¸ªå›¾ä¹¦é¦†çš„æ¯”å–»æ¥ç†è§£ Collectionï¼š

- **Collection (é›†åˆ)**: ç›¸å½“äºä¸€ä¸ª**å›¾ä¹¦é¦†**ï¼Œæ˜¯æ‰€æœ‰æ•°æ®çš„é¡¶å±‚å®¹å™¨ã€‚ä¸€ä¸ª Collection å¯ä»¥åŒ…å«å¤šä¸ª Partitionï¼Œæ¯ä¸ª Partition å¯ä»¥åŒ…å«å¤šä¸ª Entityã€‚
- **Partition (åˆ†åŒº)**: ç›¸å½“äºå›¾ä¹¦é¦†é‡Œçš„**ä¸åŒåŒºåŸŸ**ï¼ˆå¦‚â€œå°è¯´åŒºâ€ã€â€œç§‘æŠ€åŒºâ€ï¼‰ï¼Œå°†æ•°æ®ç‰©ç†éš”ç¦»ï¼Œè®©æ£€ç´¢æ›´é«˜æ•ˆã€‚
- **Schema (æ¨¡å¼)**: ç›¸å½“äºå›¾ä¹¦é¦†çš„**å›¾ä¹¦å¡ç‰‡è§„åˆ™**ï¼Œå®šä¹‰äº†æ¯æœ¬ä¹¦ï¼ˆæ•°æ®ï¼‰å¿…é¡»ç™»è®°å“ªäº›ä¿¡æ¯ï¼ˆå­—æ®µï¼‰ã€‚
- **Entity (å®ä½“)**: ç›¸å½“äº**ä¸€æœ¬å…·ä½“çš„ä¹¦**ï¼Œæ˜¯æ•°æ®æœ¬èº«ã€‚
- **Alias (åˆ«å)**: ç›¸å½“äºä¸€ä¸ª**åŠ¨æ€çš„æ¨èä¹¦å•**ï¼ˆå¦‚â€œæœ¬å‘¨ç²¾é€‰â€ï¼‰ï¼Œå®ƒå¯ä»¥æŒ‡å‘æŸä¸ªå…·ä½“çš„ Collectionï¼Œæ–¹ä¾¿åº”ç”¨å±‚è°ƒç”¨ï¼Œå®ç°æ•°æ®æ›´æ–°æ—¶çš„æ— ç¼åˆ‡æ¢ã€‚ 

**Collection** æ˜¯ Milvus ä¸­æœ€åŸºæœ¬çš„æ•°æ®ç»„ç»‡å•ä½ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ä¸€å¼ **è¡¨ (Table)**ã€‚æ˜¯æˆ‘ä»¬å­˜å‚¨ã€ç®¡ç†å’ŒæŸ¥è¯¢å‘é‡åŠç›¸å…³å…ƒæ•°æ®çš„å®¹å™¨ã€‚æ‰€æœ‰çš„æ•°æ®æ“ä½œï¼Œå¦‚æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢ç­‰ï¼Œéƒ½æ˜¯å›´ç»• Collection å±•å¼€çš„ã€‚

ä¸€ä¸ª Collection ç”±å…¶ **Schema** å®šä¹‰ï¼Œå¹¶åŒ…å«ä»¥ä¸‹é‡è¦çš„å­æ¦‚å¿µå’Œç‰¹æ€§ï¼š

#### 3.1.1 Schema

åœ¨åˆ›å»º Collection ä¹‹å‰ï¼Œå¿…é¡»å…ˆå®šä¹‰å®ƒçš„ **Schema**ã€‚ `Schema` è§„å®šäº† Collection çš„æ•°æ®ç»“æ„ï¼Œå®šä¹‰äº†å…¶ä¸­åŒ…å«çš„æ‰€æœ‰**å­—æ®µ (Field)** åŠå…¶å±æ€§ã€‚ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ Schema æ˜¯èƒ½å¤Ÿä¿è¯æ•°æ®ä¸€è‡´æ€§å¹¶æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

Schema é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ç±»å­—æ®µï¼š

- **ä¸»é”®å­—æ®µ (Primary Key Field)**: æ¯ä¸ª Collection å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä¸»é”®å­—æ®µï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ¯ä¸€æ¡æ•°æ®ï¼ˆå®ä½“ï¼‰ã€‚å®ƒçš„å€¼å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œé€šå¸¸æ˜¯æ•´æ•°æˆ–å­—ç¬¦ä¸²ç±»å‹ã€‚
- **å‘é‡å­—æ®µ (Vector Field)**: ç”¨äºå­˜å‚¨æ ¸å¿ƒçš„å‘é‡æ•°æ®ã€‚ä¸€ä¸ª Collection å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‘é‡å­—æ®µï¼Œä»¥æ»¡è¶³å¤šæ¨¡æ€ç­‰å¤æ‚åœºæ™¯çš„éœ€æ±‚ã€‚
- **æ ‡é‡å­—æ®µ (Scalar Field)**: ç”¨äºå­˜å‚¨é™¤å‘é‡ä¹‹å¤–çš„å…ƒæ•°æ®ï¼Œå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€JSON ç­‰ã€‚è¿™äº›å­—æ®µå¯ä»¥ç”¨äºè¿‡æ»¤æŸ¥è¯¢ï¼Œå®ç°æ›´ç²¾ç¡®çš„æ£€ç´¢ã€‚

![Schema è®¾è®¡å‰–æ](./images/3_4_1.webp)

ä¸Šå›¾ä»¥ä¸€ç¯‡æ–°é—»æ–‡ç« ä¸ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„å¤šæ¨¡æ€ã€æ··åˆå‘é‡ Schema è®¾è®¡ã€‚å®ƒå°†ä¸€ç¯‡æ–‡ç« æ‹†è§£ä¸ºï¼šå”¯ä¸€çš„ `Article (ID)`ã€æ–‡æœ¬å…ƒæ•°æ®ï¼ˆå¦‚ `Title`ã€`Author Info`ï¼‰ã€å›¾åƒä¿¡æ¯ï¼ˆ`Image URL`ï¼‰ï¼Œå¹¶ä¸ºå›¾åƒå’Œæ‘˜è¦å†…å®¹åˆ†åˆ«ç”Ÿæˆäº†å¯†é›†å‘é‡ï¼ˆ`Image Embedding`, `Summary Embedding`ï¼‰å’Œç¨€ç–å‘é‡ï¼ˆ`Summary Sparse Embedding`ï¼‰ã€‚

#### 3.1.2 Partition (åˆ†åŒº)

**Partition** æ˜¯ Collection å†…éƒ¨çš„ä¸€ä¸ªé€»è¾‘åˆ’åˆ†ã€‚æ¯ä¸ª Collection åœ¨åˆ›å»ºæ—¶éƒ½ä¼šæœ‰ä¸€ä¸ªåä¸º `_default` çš„é»˜è®¤åˆ†åŒºã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆ›å»ºæ›´å¤šçš„åˆ†åŒºï¼Œå°†æ•°æ®æŒ‰ç‰¹å®šè§„åˆ™ï¼ˆå¦‚ç±»åˆ«ã€æ—¥æœŸç­‰ï¼‰å­˜å…¥ä¸åŒåˆ†åŒºã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨åˆ†åŒºï¼Ÿ**

- **æå‡æŸ¥è¯¢æ€§èƒ½**: åœ¨æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥æŒ‡å®šåªåœ¨ä¸€ä¸ªæˆ–å‡ ä¸ªåˆ†åŒºå†…è¿›è¡Œæœç´¢ï¼Œä»è€Œå¤§å¹…å‡å°‘éœ€è¦æ‰«æçš„æ•°æ®é‡ï¼Œæ˜¾è‘—æå‡æ£€ç´¢é€Ÿåº¦ã€‚
- **æ•°æ®ç®¡ç†**: ä¾¿äºå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ‰¹é‡æ“ä½œï¼Œå¦‚åŠ è½½/å¸è½½ç‰¹å®šåˆ†åŒºåˆ°å†…å­˜ï¼Œæˆ–è€…åˆ é™¤æ•´ä¸ªåˆ†åŒºçš„æ•°æ®ã€‚

ä¸€ä¸ª Collection æœ€å¤šå¯ä»¥æœ‰ 1024 ä¸ªåˆ†åŒºã€‚åˆç†åˆ©ç”¨åˆ†åŒºæ˜¯ Milvus æ€§èƒ½ä¼˜åŒ–çš„é‡è¦æ‰‹æ®µä¹‹ä¸€ã€‚

#### 3.1.3 Alias (åˆ«å)

**Alias** (åˆ«å) æ˜¯ä¸º Collection æä¾›çš„ä¸€ä¸ªâ€œæ˜µç§°â€ã€‚é€šè¿‡ä¸ºä¸€ä¸ª Collection è®¾ç½®åˆ«åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è¿™ä¸ªåˆ«åæ¥æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨çœŸå®çš„ Collection åç§°ã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨åˆ«åï¼Ÿ**

- **å®‰å…¨åœ°æ›´æ–°æ•°æ®**ï¼šæƒ³è±¡ä¸€ä¸‹ï¼Œä½ éœ€è¦å¯¹ä¸€ä¸ªåœ¨çº¿æœåŠ¡çš„ Collection è¿›è¡Œå¤§è§„æ¨¡çš„æ•°æ®æ›´æ–°æˆ–é‡å»ºç´¢å¼•ã€‚ç›´æ¥åœ¨åŸ Collection ä¸Šæ“ä½œé£é™©å¾ˆé«˜ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ï¼š
    1. åˆ›å»ºä¸€ä¸ªæ–°çš„ Collection (`collection_v2`) å¹¶å¯¼å…¥ã€ç´¢å¼•å¥½æ‰€æœ‰æ–°æ•°æ®ã€‚
    2. å°†æŒ‡å‘æ—§ Collection (`collection_v1`) çš„åˆ«åï¼ˆä¾‹å¦‚ `my_app_collection`ï¼‰åŸå­æ€§åœ°åˆ‡æ¢åˆ°æ–° Collection (`collection_v2`) ä¸Šã€‚
- **ä»£ç è§£è€¦**ï¼šæ•´ä¸ªåˆ‡æ¢è¿‡ç¨‹å¯¹ä¸Šå±‚åº”ç”¨å®Œå…¨é€æ˜ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç æˆ–é‡å¯æœåŠ¡ï¼Œå®ç°äº†æ•°æ®çš„å¹³æ»‘æ— ç¼å‡çº§ã€‚

### 3.2 ç´¢å¼• (Index)

å¦‚æœè¯´ Collection æ˜¯ Milvus çš„éª¨æ¶ï¼Œé‚£ä¹ˆ**ç´¢å¼• (Index)** å°±æ˜¯å…¶åŠ é€Ÿæ£€ç´¢çš„ç¥ç»ç³»ç»Ÿã€‚ä»å®è§‚ä¸Šçœ‹ï¼Œç´¢å¼•æœ¬èº«å°±æ˜¯ä¸€ç§**ä¸ºäº†åŠ é€ŸæŸ¥è¯¢è€Œè®¾è®¡çš„å¤æ‚æ•°æ®ç»“æ„**ã€‚å¯¹å‘é‡æ•°æ®åˆ›å»ºç´¢å¼•åï¼ŒMilvus å¯ä»¥æå¤§åœ°æå‡å‘é‡ç›¸ä¼¼æ€§æœç´¢çš„é€Ÿåº¦ï¼Œä»£ä»·æ˜¯ä¼šå ç”¨é¢å¤–çš„å­˜å‚¨å’Œå†…å­˜èµ„æºã€‚

![Milvus ç´¢å¼•ç»“æ„ä¸å·¥ä½œåŸç†](./images/3_4_2.webp)

ä¸Šå›¾æ¸…æ™°åœ°å±•ç¤ºäº† Milvus å‘é‡ç´¢å¼•çš„å†…éƒ¨ç»„ä»¶åŠå…¶å·¥ä½œæµç¨‹ï¼š
- **æ•°æ®ç»“æ„**ï¼šè¿™æ˜¯ç´¢å¼•çš„éª¨æ¶ï¼Œå®šä¹‰äº†å‘é‡çš„ç»„ç»‡æ–¹å¼ï¼ˆå¦‚ HNSW ä¸­çš„å›¾ç»“æ„ï¼‰ã€‚
- **é‡åŒ–**(å¯é€‰)ï¼šæ•°æ®å‹ç¼©æŠ€æœ¯ï¼Œé€šè¿‡é™ä½å‘é‡ç²¾åº¦æ¥å‡å°‘å†…å­˜å ç”¨å’ŒåŠ é€Ÿè®¡ç®—ã€‚
- **ç»“æœç²¾ç‚¼**(å¯é€‰)ï¼šåœ¨æ‰¾åˆ°åˆæ­¥å€™é€‰é›†åï¼Œè¿›è¡Œæ›´ç²¾ç¡®çš„è®¡ç®—ä»¥ä¼˜åŒ–æœ€ç»ˆç»“æœã€‚

Milvus æ”¯æŒå¯¹æ ‡é‡å­—æ®µå’Œå‘é‡å­—æ®µåˆ†åˆ«åˆ›å»ºç´¢å¼•ã€‚

- **æ ‡é‡å­—æ®µç´¢å¼•**ï¼šä¸»è¦ç”¨äºåŠ é€Ÿå…ƒæ•°æ®è¿‡æ»¤ï¼Œå¸¸ç”¨çš„æœ‰ `INVERTED`ã€`BITMAP` ç­‰ã€‚é€šå¸¸ä½¿ç”¨æ¨èçš„ç´¢å¼•ç±»å‹å³å¯ã€‚
- **å‘é‡å­—æ®µç´¢å¼•**ï¼šè¿™æ˜¯ Milvus çš„æ ¸å¿ƒã€‚é€‰æ‹©åˆé€‚çš„å‘é‡ç´¢å¼•æ˜¯åœ¨æŸ¥è¯¢æ€§èƒ½ã€å¬å›ç‡å’Œå†…å­˜å ç”¨ä¹‹é—´åšå‡ºæƒè¡¡çš„è‰ºæœ¯ã€‚

#### 3.2.1 ä¸»è¦å‘é‡ç´¢å¼•ç±»å‹

Milvus æä¾›äº†å¤šç§å‘é‡ç´¢å¼•ç®—æ³•ï¼Œä»¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å‡ ç§æœ€æ ¸å¿ƒçš„ç±»å‹ï¼š

- **FLAT (ç²¾ç¡®æŸ¥æ‰¾)**
  - **åŸç†**ï¼šæš´åŠ›æœç´¢ï¼ˆBrute-force Searchï¼‰ã€‚å®ƒä¼šè®¡ç®—æŸ¥è¯¢å‘é‡ä¸é›†åˆä¸­æ‰€æœ‰å‘é‡ä¹‹é—´çš„å®é™…è·ç¦»ï¼Œè¿”å›æœ€ç²¾ç¡®çš„ç»“æœã€‚
  - **ä¼˜ç‚¹**ï¼š100% çš„å¬å›ç‡ï¼Œç»“æœæœ€å‡†ç¡®ã€‚
  - **ç¼ºç‚¹**ï¼šé€Ÿåº¦æ…¢ï¼Œå†…å­˜å ç”¨å¤§ï¼Œä¸é€‚åˆæµ·é‡æ•°æ®ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ç²¾åº¦è¦æ±‚æé«˜ï¼Œä¸”æ•°æ®è§„æ¨¡è¾ƒå°ï¼ˆç™¾ä¸‡çº§ä»¥å†…ï¼‰çš„åœºæ™¯ã€‚

- **IVF ç³»åˆ— (å€’æ’æ–‡ä»¶ç´¢å¼•)**
  - **åŸç†**ï¼šç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ã€‚å®ƒé¦–å…ˆé€šè¿‡èšç±»å°†æ‰€æœ‰å‘é‡åˆ†æˆå¤šä¸ªâ€œæ¡¶â€(`nlist`)ï¼ŒæŸ¥è¯¢æ—¶ï¼Œå…ˆæ‰¾åˆ°æœ€ç›¸ä¼¼çš„å‡ ä¸ªâ€œæ¡¶â€ï¼Œç„¶ååªåœ¨è¿™å‡ ä¸ªæ¡¶å†…è¿›è¡Œç²¾ç¡®æœç´¢ã€‚`IVF_FLAT`ã€`IVF_SQ8`ã€`IVF_PQ` æ˜¯å…¶ä¸åŒå˜ä½“ï¼Œä¸»è¦åŒºåˆ«åœ¨äºæ˜¯å¦å¯¹æ¡¶å†…å‘é‡è¿›è¡Œäº†å‹ç¼©ï¼ˆé‡åŒ–ï¼‰ã€‚
  - **ä¼˜ç‚¹**ï¼šé€šè¿‡ç¼©å°æœç´¢èŒƒå›´ï¼Œæå¤§åœ°æå‡äº†æ£€ç´¢é€Ÿåº¦ï¼Œæ˜¯æ€§èƒ½å’Œæ•ˆæœä¹‹é—´å¾ˆå¥½çš„å¹³è¡¡ã€‚
  - **ç¼ºç‚¹**ï¼šå¬å›ç‡ä¸æ˜¯100%ï¼Œå› ä¸ºç›¸å…³å‘é‡å¯èƒ½è¢«åˆ†åˆ°äº†æœªè¢«æœç´¢çš„æ¡¶ä¸­ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šé€šç”¨åœºæ™¯ï¼Œå°¤å…¶é€‚åˆéœ€è¦é«˜ååé‡çš„å¤§è§„æ¨¡æ•°æ®é›†ã€‚

- **HNSW (åŸºäºå›¾çš„ç´¢å¼•)**
  - **åŸç†**ï¼šæ„å»ºä¸€ä¸ªå¤šå±‚çš„é‚»è¿‘å›¾ã€‚æŸ¥è¯¢æ—¶ä»æœ€ä¸Šå±‚çš„ç¨€ç–å›¾å¼€å§‹ï¼Œå¿«é€Ÿå®šä½åˆ°ç›®æ ‡åŒºåŸŸï¼Œç„¶ååœ¨ä¸‹å±‚çš„å¯†é›†å›¾ä¸­è¿›è¡Œç²¾ç¡®æœç´¢ã€‚
  - **ä¼˜ç‚¹**ï¼šæ£€ç´¢é€Ÿåº¦æå¿«ï¼Œå¬å›ç‡é«˜ï¼Œå°¤å…¶æ“…é•¿å¤„ç†é«˜ç»´æ•°æ®å’Œä½å»¶è¿ŸæŸ¥è¯¢ã€‚
  - **ç¼ºç‚¹**ï¼šå†…å­˜å ç”¨éå¸¸å¤§ï¼Œæ„å»ºç´¢å¼•çš„æ—¶é—´ä¹Ÿè¾ƒé•¿ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šå¯¹æŸ¥è¯¢å»¶è¿Ÿæœ‰ä¸¥æ ¼è¦æ±‚ï¼ˆå¦‚å®æ—¶æ¨èã€åœ¨çº¿æœç´¢ï¼‰çš„åœºæ™¯ã€‚

- **DiskANN (åŸºäºç£ç›˜çš„ç´¢å¼•)**
  - **åŸç†**ï¼šä¸€ç§ä¸ºåœ¨ SSD ç­‰é«˜é€Ÿç£ç›˜ä¸Šè¿è¡Œè€Œä¼˜åŒ–çš„å›¾ç´¢å¼•ã€‚
  - **ä¼˜ç‚¹**ï¼šæ”¯æŒè¿œè¶…å†…å­˜å®¹é‡çš„æµ·é‡æ•°æ®é›†ï¼ˆåäº¿çº§ç”šè‡³æ›´å¤šï¼‰ï¼ŒåŒæ—¶ä¿æŒè¾ƒä½çš„æŸ¥è¯¢å»¶è¿Ÿã€‚
  - **ç¼ºç‚¹**ï¼šç›¸æ¯”çº¯å†…å­˜ç´¢å¼•ï¼Œå»¶è¿Ÿç¨é«˜ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®è§„æ¨¡å·¨å¤§ï¼Œæ— æ³•å…¨éƒ¨åŠ è½½åˆ°å†…å­˜çš„åœºæ™¯ã€‚

#### 3.2.2 å¦‚ä½•é€‰æ‹©ç´¢å¼•ï¼Ÿ

é€‰æ‹©ç´¢å¼•æ²¡æœ‰å”¯ä¸€çš„â€œæœ€ä½³ç­”æ¡ˆâ€ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯åœ¨**æ•°æ®è§„æ¨¡ã€å†…å­˜é™åˆ¶ã€æŸ¥è¯¢æ€§èƒ½å’Œå¬å›ç‡**ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚

| åœºæ™¯ | æ¨èç´¢å¼• | å¤‡æ³¨ |
| :--- | :--- | :--- |
| æ•°æ®å¯å®Œå…¨è½½å…¥å†…å­˜ï¼Œè¿½æ±‚ä½å»¶è¿Ÿ | **HNSW** | å†…å­˜å ç”¨è¾ƒå¤§ï¼Œä½†æŸ¥è¯¢æ€§èƒ½å’Œå¬å›ç‡éƒ½å¾ˆä¼˜ç§€ã€‚ |
| æ•°æ®å¯å®Œå…¨è½½å…¥å†…å­˜ï¼Œè¿½æ±‚é«˜åå | **IVF_FLAT / IVF_SQ8** | æ€§èƒ½å’Œèµ„æºæ¶ˆè€—çš„å¹³è¡¡ä¹‹é€‰ã€‚ |
| æ•°æ®é‡å·¨å¤§ï¼Œæ— æ³•è½½å…¥å†…å­˜ | **DiskANN** | åœ¨ SSD ä¸Šæ€§èƒ½ä¼˜å¼‚ï¼Œä¸“ä¸ºæµ·é‡æ•°æ®è®¾è®¡ã€‚ |
| è¿½æ±‚ 100% å‡†ç¡®ç‡ï¼Œæ•°æ®é‡ä¸å¤§ | **FLAT** | æš´åŠ›æœç´¢ï¼Œç¡®ä¿ç»“æœæœ€ç²¾ç¡®ã€‚ |

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸éœ€è¦é€šè¿‡æµ‹è¯•æ¥æ‰¾åˆ°æœ€é€‚åˆè‡ªå·±æ•°æ®å’ŒæŸ¥è¯¢æ¨¡å¼çš„ç´¢å¼•ç±»å‹åŠå…¶å‚æ•°ã€‚

### 3.3 æ£€ç´¢

#### 3.3.1 åŸºç¡€å‘é‡æ£€ç´¢ (ANN Search)

æ‹¥æœ‰äº†æ•°æ®å®¹å™¨ (Collection) å’Œæ£€ç´¢å¼•æ“ (Index) åï¼Œæœ€åä¸€æ­¥å°±æ˜¯ä»æµ·é‡æ•°æ®ä¸­é«˜æ•ˆåœ°æ£€ç´¢ä¿¡æ¯ã€‚è¿™æ˜¯ Milvus çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œ**è¿‘ä¼¼æœ€è¿‘é‚» (Approximate Nearest Neighbor, ANN) æ£€ç´¢**ã€‚ä¸éœ€è¦è®¡ç®—å…¨éƒ¨æ•°æ®çš„æš´åŠ›æ£€ç´¢ï¼ˆBrute-force Searchï¼‰ä¸åŒï¼ŒANN æ£€ç´¢åˆ©ç”¨é¢„å…ˆæ„å»ºå¥½çš„ç´¢å¼•ï¼Œèƒ½å¤Ÿæé€Ÿåœ°ä»æµ·é‡æ•°æ®ä¸­æ‰¾åˆ°ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„ Top-K ä¸ªç»“æœã€‚è¿™æ˜¯ä¸€ç§åœ¨é€Ÿåº¦å’Œç²¾åº¦ä¹‹é—´å–å¾—æè‡´å¹³è¡¡çš„ç­–ç•¥ã€‚

- **ä¸»è¦å‚æ•°**:
  - `anns_field`: æŒ‡å®šè¦åœ¨å“ªä¸ªå‘é‡å­—æ®µä¸Šè¿›è¡Œæ£€ç´¢ã€‚
  - `data`: ä¼ å…¥ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å‘é‡ã€‚
  - `limit` (æˆ– `top_k`): æŒ‡å®šéœ€è¦è¿”å›çš„æœ€ç›¸ä¼¼ç»“æœçš„æ•°é‡ã€‚
  - `search_params`: æŒ‡å®šæ£€ç´¢æ—¶ä½¿ç”¨çš„å‚æ•°ï¼Œä¾‹å¦‚è·ç¦»è®¡ç®—æ–¹å¼ (`metric_type`) å’Œç´¢å¼•ç›¸å…³çš„æŸ¥è¯¢å‚æ•°ã€‚

#### 3.3.2 å¢å¼ºæ£€ç´¢

åœ¨åŸºç¡€çš„ ANN æ£€ç´¢ä¹‹ä¸Šï¼ŒMilvus æä¾›äº†å¤šç§å¢å¼ºæ£€ç´¢åŠŸèƒ½ï¼Œä»¥æ»¡è¶³æ›´å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚

**è¿‡æ»¤æ£€ç´¢ (Filtered Search)**

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¾ˆå°‘åªè¿›è¡Œå•çº¯çš„å‘é‡æ£€ç´¢ã€‚æ›´å¸¸è§çš„éœ€æ±‚æ˜¯â€œåœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å‘é‡ä¸­ï¼ŒæŸ¥æ‰¾æœ€ç›¸ä¼¼çš„ç»“æœâ€ï¼Œè¿™å°±æ˜¯è¿‡æ»¤æ£€ç´¢ã€‚å®ƒå°†**å‘é‡ç›¸ä¼¼æ€§æ£€ç´¢**ä¸**æ ‡é‡å­—æ®µè¿‡æ»¤**ç»“åˆåœ¨ä¸€èµ·ã€‚

- **å·¥ä½œåŸç†**ï¼šå…ˆæ ¹æ®æä¾›çš„è¿‡æ»¤è¡¨è¾¾å¼ (`filter`) ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„å®ä½“ï¼Œç„¶åä»…åœ¨è¿™ä¸ªå­é›†å†…æ‰§è¡Œ ANN æ£€ç´¢ã€‚è¿™æå¤§åœ°æé«˜äº†æŸ¥è¯¢çš„ç²¾å‡†åº¦ã€‚
- **åº”ç”¨ç¤ºä¾‹**ï¼š
  - **ç”µå•†**ï¼š"æ£€ç´¢ä¸è¿™ä»¶çº¢è‰²è¿è¡£è£™æœ€ç›¸ä¼¼çš„å•†å“ï¼Œä½†åªçœ‹ä»·æ ¼ä½äº500å…ƒä¸”æœ‰åº“å­˜çš„ã€‚"
  - **çŸ¥è¯†åº“**ï¼š"æŸ¥æ‰¾ä¸â€˜äººå·¥æ™ºèƒ½â€™ç›¸å…³çš„æ–‡æ¡£ï¼Œä½†åªä»â€˜æŠ€æœ¯â€™åˆ†ç±»ä¸‹ã€ä¸”å‘å¸ƒäº2023å¹´ä¹‹åçš„æ–‡ç« ä¸­å¯»æ‰¾ã€‚"

**èŒƒå›´æ£€ç´¢ (Range Search)**

æœ‰æ—¶æˆ‘ä»¬å…³å¿ƒçš„ä¸æ˜¯æœ€ç›¸ä¼¼çš„ Top-K ä¸ªç»“æœï¼Œè€Œæ˜¯â€œæ‰€æœ‰ä¸æŸ¥è¯¢å‘é‡çš„ç›¸ä¼¼åº¦åœ¨ç‰¹å®šèŒƒå›´å†…çš„ç»“æœâ€ã€‚

- **å·¥ä½œåŸç†**ï¼šèŒƒå›´æ£€ç´¢å…è®¸å®šä¹‰ä¸€ä¸ªè·ç¦»ï¼ˆæˆ–ç›¸ä¼¼åº¦ï¼‰çš„é˜ˆå€¼èŒƒå›´ã€‚Milvus ä¼šè¿”å›æ‰€æœ‰ä¸æŸ¥è¯¢å‘é‡çš„è·ç¦»è½åœ¨è¿™ä¸ªèŒƒå›´å†…çš„å®ä½“ã€‚
- **åº”ç”¨ç¤ºä¾‹**ï¼š
  - **äººè„¸è¯†åˆ«**ï¼š"æŸ¥æ‰¾æ‰€æœ‰ä¸ç›®æ ‡äººè„¸ç›¸ä¼¼åº¦è¶…è¿‡ 0.9 çš„äººè„¸"ï¼Œç”¨äºèº«ä»½éªŒè¯ã€‚
  - **å¼‚å¸¸æ£€æµ‹**ï¼š"æŸ¥æ‰¾æ‰€æœ‰ä¸æ­£å¸¸æ ·æœ¬å‘é‡è·ç¦»è¿‡å¤§çš„æ•°æ®ç‚¹"ï¼Œç”¨äºå‘ç°å¼‚å¸¸ã€‚

**å¤šå‘é‡æ··åˆæ£€ç´¢ (Hybrid Search)**

è¿™æ˜¯ Milvus æä¾›çš„ä¸€ç§æå…¶å¼ºå¤§çš„é«˜çº§æ£€ç´¢æ¨¡å¼ï¼Œå®ƒå…è®¸åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­åŒæ—¶æ£€ç´¢**å¤šä¸ªå‘é‡å­—æ®µ**ï¼Œå¹¶å°†ç»“æœæ™ºèƒ½åœ°èåˆåœ¨ä¸€èµ·ã€‚

- **å·¥ä½œåŸç†**ï¼š
  1. **å¹¶è¡Œæ£€ç´¢**ï¼šåº”ç”¨é’ˆå¯¹ä¸åŒçš„å‘é‡å­—æ®µï¼ˆå¦‚ä¸€ä¸ªç”¨äºæ–‡æœ¬è¯­ä¹‰çš„å¯†é›†å‘é‡ï¼Œä¸€ä¸ªç”¨äºå…³é”®è¯åŒ¹é…çš„ç¨€ç–å‘é‡ï¼Œä¸€ä¸ªç”¨äºå›¾åƒå†…å®¹çš„å¤šæ¨¡æ€å‘é‡ï¼‰åˆ†åˆ«å‘èµ· ANN æ£€ç´¢è¯·æ±‚ã€‚
  2. **ç»“æœèåˆ (Rerank)**ï¼šMilvus ä½¿ç”¨ä¸€ä¸ªé‡æ’ç­–ç•¥ï¼ˆRerankerï¼‰å°†æ¥è‡ªä¸åŒæ£€ç´¢æµçš„ç»“æœåˆå¹¶æˆä¸€ä¸ªç»Ÿä¸€çš„ã€æ›´é«˜è´¨é‡çš„æ’åºåˆ—è¡¨ã€‚å¸¸ç”¨çš„ç­–ç•¥æœ‰ `RRFRanker`ï¼ˆå¹³è¡¡å„æ–¹ç»“æœï¼‰å’Œ `WeightedRanker`ï¼ˆå¯ä¸ºç‰¹å®šå­—æ®µç»“æœåŠ æƒï¼‰ã€‚

- **åº”ç”¨ç¤ºä¾‹**ï¼š
  - **å¤šæ¨¡æ€å•†å“æ£€ç´¢**ï¼šç”¨æˆ·è¾“å…¥æ–‡æœ¬â€œå®‰é™èˆ’é€‚çš„ç™½è‰²è€³æœºâ€ï¼Œç³»ç»Ÿå¯ä»¥åŒæ—¶æ£€ç´¢å•†å“çš„**æ–‡æœ¬æè¿°å‘é‡**å’Œ**å›¾ç‰‡å†…å®¹å‘é‡**ï¼Œè¿”å›æœ€åŒ¹é…çš„å•†å“ã€‚
  - **å¢å¼ºå‹ RAG**: ç»“åˆ**å¯†é›†å‘é‡**ï¼ˆæ•æ‰è¯­ä¹‰ï¼‰å’Œ**ç¨€ç–å‘é‡**ï¼ˆç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼‰ï¼Œå®ç°æ¯”å•ä¸€å‘é‡æ›´ç²¾å‡†çš„æ–‡æ¡£æ£€ç´¢æ•ˆæœã€‚

**åˆ†ç»„æ£€ç´¢ (Grouping Search)**

åˆ†ç»„æ£€ç´¢è§£å†³äº†ä¸€ä¸ªå¸¸è§çš„ç—›ç‚¹ï¼šæ£€ç´¢ç»“æœå¤šæ ·æ€§ä¸è¶³ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ£€ç´¢â€œæœºå™¨å­¦ä¹ â€ï¼Œè¿”å›çš„å‰10ç¯‡æ–‡ç« éƒ½æ¥è‡ªåŒä¸€æœ¬æ•™ç§‘ä¹¦ä¸åŒç« èŠ‚ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯ç†æƒ³çš„ç»“æœã€‚

- **å·¥ä½œåŸç†**ï¼šåˆ†ç»„æ£€ç´¢å…è®¸æŒ‡å®šä¸€ä¸ªå­—æ®µï¼ˆå¦‚ `document_id`ï¼‰å¯¹ç»“æœè¿›è¡Œåˆ†ç»„ã€‚Milvus ä¼šåœ¨æ£€ç´¢åï¼Œç¡®ä¿è¿”å›çš„ç»“æœä¸­æ¯ä¸ªç»„ï¼ˆæ¯ä¸ª `document_id`ï¼‰åªå‡ºç°ä¸€æ¬¡ï¼ˆæˆ–æŒ‡å®šçš„æ¬¡æ•°ï¼‰ï¼Œä¸”è¿”å›çš„æ˜¯è¯¥ç»„å†…ä¸æŸ¥è¯¢æœ€ç›¸ä¼¼çš„é‚£ä¸ªå®ä½“ã€‚
- **åº”ç”¨ç¤ºä¾‹**ï¼š
  - **è§†é¢‘æ£€ç´¢**ï¼šæ£€ç´¢â€œå¯çˆ±çš„çŒ«å’ªâ€ï¼Œç¡®ä¿è¿”å›çš„è§†é¢‘æ¥è‡ªä¸åŒçš„åšä¸»ã€‚
  - **æ–‡æ¡£æ£€ç´¢**ï¼šæ£€ç´¢â€œæ•°æ®åº“ç´¢å¼•â€ï¼Œç¡®ä¿è¿”å›çš„ç»“æœæ¥è‡ªä¸åŒçš„ä¹¦ç±æˆ–æ¥æºã€‚

é€šè¿‡è¿™äº›çµæ´»çš„æ£€ç´¢åŠŸèƒ½ç»„åˆï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºå‡ºæ»¡è¶³å„ç§å¤æ‚ä¸šåŠ¡éœ€æ±‚çš„å‘é‡æ£€ç´¢åº”ç”¨ã€‚

## å››ã€milvuså¤šæ¨¡æ€å®è·µ

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Milvus å’Œ Visualized-BGE æ¨¡å‹æ„å»ºä¸€ä¸ªç«¯åˆ°ç«¯çš„å›¾æ–‡å¤šæ¨¡æ€æ£€ç´¢å¼•æ“ã€‚

### 4.1 åˆå§‹åŒ–ä¸å·¥å…·å®šä¹‰

é¦–å…ˆå¯¼å…¥æ‰€æœ‰å¿…éœ€çš„åº“ï¼Œå®šä¹‰å¥½æ¨¡å‹è·¯å¾„ã€æ•°æ®ç›®å½•ç­‰å¸¸é‡ã€‚ä¸ºäº†ä»£ç çš„æ•´æ´å’Œå¤ç”¨ï¼Œå°† Visualized-BGE æ¨¡å‹çš„åŠ è½½å’Œç¼–ç é€»è¾‘å°è£…åœ¨ä¸€ä¸ª `Encoder` ç±»ä¸­ï¼Œå¹¶å®šä¹‰äº†ä¸€ä¸ª `visualize_results` å‡½æ•°ç”¨äºåç»­çš„ç»“æœå¯è§†åŒ–ã€‚

```python
import os
from tqdm import tqdm
from glob import glob
import torch
from visual_bge.visual_bge.modeling import Visualized_BGE
from pymilvus import MilvusClient, FieldSchema, CollectionSchema, DataType
import numpy as np
import cv2
from PIL import Image

# 1. åˆå§‹åŒ–è®¾ç½®
MODEL_NAME = "BAAI/bge-base-en-v1.5"
MODEL_PATH = "../../models/bge/Visualized_base_en_v1.5.pth"
DATA_DIR = "../../data/C3"
COLLECTION_NAME = "multimodal_demo"
MILVUS_URI = "http://localhost:19530"

# 2. å®šä¹‰å·¥å…· (ç¼–ç å™¨å’Œå¯è§†åŒ–å‡½æ•°)
class Encoder:
    """ç¼–ç å™¨ç±»ï¼Œç”¨äºå°†å›¾åƒå’Œæ–‡æœ¬ç¼–ç ä¸ºå‘é‡ã€‚"""
    def __init__(self, model_name: str, model_path: str):
        self.model = Visualized_BGE(model_name_bge=model_name, model_weight=model_path)
        self.model.eval()

    def encode_query(self, image_path: str, text: str) -> list[float]:
        with torch.no_grad():
            query_emb = self.model.encode(image=image_path, text=text)
        return query_emb.tolist()[0]

    def encode_image(self, image_path: str) -> list[float]:
        with torch.no_grad():
            query_emb = self.model.encode(image=image_path)
        return query_emb.tolist()[0]

def visualize_results(query_image_path: str, retrieved_images: list, img_height: int = 300, img_width: int = 300, row_count: int = 3) -> np.ndarray:
    """ä»æ£€ç´¢åˆ°çš„å›¾åƒåˆ—è¡¨åˆ›å»ºä¸€ä¸ªå…¨æ™¯å›¾ç”¨äºå¯è§†åŒ–ã€‚"""
    panoramic_width = img_width * row_count
    panoramic_height = img_height * row_count
    panoramic_image = np.full((panoramic_height, panoramic_width, 3), 255, dtype=np.uint8)
    query_display_area = np.full((panoramic_height, img_width, 3), 255, dtype=np.uint8)

    # å¤„ç†æŸ¥è¯¢å›¾åƒ
    query_pil = Image.open(query_image_path).convert("RGB")
    query_cv = np.array(query_pil)[:, :, ::-1]
    resized_query = cv2.resize(query_cv, (img_width, img_height))
    bordered_query = cv2.copyMakeBorder(resized_query, 10, 10, 10, 10, cv2.BORDER_CONSTANT, value=(255, 0, 0))
    query_display_area[img_height * (row_count - 1):, :] = cv2.resize(bordered_query, (img_width, img_height))
    cv2.putText(query_display_area, "Query", (10, panoramic_height - 20), cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 0, 0), 2)

    # å¤„ç†æ£€ç´¢åˆ°çš„å›¾åƒ
    for i, img_path in enumerate(retrieved_images):
        row, col = i // row_count, i % row_count
        start_row, start_col = row * img_height, col * img_width
        
        retrieved_pil = Image.open(img_path).convert("RGB")
        retrieved_cv = np.array(retrieved_pil)[:, :, ::-1]
        resized_retrieved = cv2.resize(retrieved_cv, (img_width - 4, img_height - 4))
        bordered_retrieved = cv2.copyMakeBorder(resized_retrieved, 2, 2, 2, 2, cv2.BORDER_CONSTANT, value=(0, 0, 0))
        panoramic_image[start_row:start_row + img_height, start_col:start_col + img_width] = bordered_retrieved
        
        # æ·»åŠ ç´¢å¼•å·
        cv2.putText(panoramic_image, str(i), (start_col + 10, start_row + 30), cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)

    return np.hstack([query_display_area, panoramic_image])
```

### 4.2 åˆ›å»º Collection

è¿™æ˜¯ä¸ Milvus äº¤äº’çš„å¼€å§‹ã€‚é¦–å…ˆåˆå§‹åŒ– Milvus å®¢æˆ·ç«¯ï¼Œç„¶åå®šä¹‰ Collection çš„ Schemaï¼Œå®ƒè§„å®šäº†é›†åˆçš„æ•°æ®ç»“æ„ã€‚

```python
# 3. åˆå§‹åŒ–å®¢æˆ·ç«¯
print("--> æ­£åœ¨åˆå§‹åŒ–ç¼–ç å™¨å’ŒMilvuså®¢æˆ·ç«¯...")
encoder = Encoder(MODEL_NAME, MODEL_PATH)
milvus_client = MilvusClient(uri=MILVUS_URI)

# 4. åˆ›å»º Milvus Collection
print(f"\n--> æ­£åœ¨åˆ›å»º Collection '{COLLECTION_NAME}'")
if milvus_client.has_collection(COLLECTION_NAME):
    milvus_client.drop_collection(COLLECTION_NAME)
    print(f"å·²åˆ é™¤å·²å­˜åœ¨çš„ Collection: '{COLLECTION_NAME}'")

image_list = glob(os.path.join(DATA_DIR, "dragon", "*.png"))
if not image_list:
    raise FileNotFoundError(f"åœ¨ {DATA_DIR}/dragon/ ä¸­æœªæ‰¾åˆ°ä»»ä½• .png å›¾åƒã€‚")
dim = len(encoder.encode_image(image_list[0]))

fields = [
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True),
    FieldSchema(name="vector", dtype=DataType.FLOAT_VECTOR, dim=dim),
    FieldSchema(name="image_path", dtype=DataType.VARCHAR, max_length=512),
]

# åˆ›å»ºé›†åˆ Schema
schema = CollectionSchema(fields, description="å¤šæ¨¡æ€å›¾æ–‡æ£€ç´¢")
print("Schema ç»“æ„:")
print(schema)

# åˆ›å»ºé›†åˆ
milvus_client.create_collection(collection_name=COLLECTION_NAME, schema=schema)
print(f"æˆåŠŸåˆ›å»º Collection: '{COLLECTION_NAME}'")
print("Collection ç»“æ„:")
print(milvus_client.describe_collection(collection_name=COLLECTION_NAME))
```

**è¾“å‡ºç»“æœï¼š**
```bash
--> æ­£åœ¨åˆ›å»º Collection 'multimodal_demo'

Schema ç»“æ„:
{
    'auto_id': True, 
    'description': 'å¤šæ¨¡æ€å›¾æ–‡æ£€ç´¢', 
    'fields': [
        {'name': 'id', 'description': '', 'type': <DataType.INT64: 5>, 'is_primary': True, 'auto_id': True}, 
        {'name': 'vector', 'description': '', 'type': <DataType.FLOAT_VECTOR: 101>, 'params': {'dim': 768}}, 
        {'name': 'image_path', 'description': '', 'type': <DataType.VARCHAR: 21>, 'params': {'max_length': 512}}
    ], 
    'enable_dynamic_field': False
}

æˆåŠŸåˆ›å»º Collection: 'multimodal_demo'

Collection ç»“æ„:
{
    'collection_name': 'multimodal_demo', 
    'auto_id': True, 
    'num_shards': 1, 
    'description': 'å¤šæ¨¡æ€å›¾æ–‡æ£€ç´¢', 
    'fields': [
        {'field_id': 100, 'name': 'id', 'description': '', 'type': <DataType.INT64: 5>, 'params': {}, 'auto_id': True, 'is_primary': True}, 
        {'field_id': 101, 'name': 'vector', 'description': '', 'type': <DataType.FLOAT_VECTOR: 101>, 'params': {'dim': 768}}, 
        {'field_id': 102, 'name': 'image_path', 'description': '', 'type': <DataType.VARCHAR: 21>, 'params': {'max_length': 512}}
    ], 
    'functions': [], 
    'aliases': [], 
    'collection_id': 459243798405253751, 
    'consistency_level': 2, 
    'properties': {}, 
    'num_partitions': 1, 
    'enable_dynamic_field': False, 
    'created_timestamp': 459249546649403396, 
    'update_timestamp': 459249546649403396
}
```

ä¸Šé¢çš„è¾“å‡ºè¯¦ç»†å±•ç¤ºäº†åˆšåˆšåˆ›å»ºçš„ `multimodal_demo` Collection çš„å®Œæ•´ç»“æ„ã€‚å…¶ **Schema** åŒ…å«äº†ä¸‰ä¸ªæ ¸å¿ƒå­—æ®µï¼ˆ**Field**ï¼‰ï¼šä¸€ä¸ªè‡ªå¢çš„ `id` ä½œä¸º**ä¸»é”®**ï¼Œä¸€ä¸ª 768 ç»´çš„ `vector` **å‘é‡å­—æ®µ**ç”¨äºå­˜å‚¨å›¾åƒåµŒå…¥ï¼Œä»¥åŠä¸€ä¸ª `image_path` **æ ‡é‡å­—æ®µ**æ¥è®°å½•åŸå§‹å›¾ç‰‡è·¯å¾„ã€‚

### 4.3 å‡†å¤‡å¹¶æ’å…¥æ•°æ®

åˆ›å»ºå¥½ Collection åï¼Œéœ€è¦å°†æ•°æ®å¡«å……è¿›å»ã€‚é€šè¿‡éå†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡ï¼Œå°†å®ƒä»¬é€ä¸€ç¼–ç æˆå‘é‡ï¼Œç„¶åä¸å›¾ç‰‡è·¯å¾„ä¸€èµ·ç»„ç»‡æˆç¬¦åˆ Schema ç»“æ„çš„æ ¼å¼ï¼Œæœ€åæ‰¹é‡æ’å…¥åˆ° Collection ä¸­ã€‚

```python
# 5. å‡†å¤‡å¹¶æ’å…¥æ•°æ®
print(f"\n--> æ­£åœ¨å‘ '{COLLECTION_NAME}' æ’å…¥æ•°æ®")
data_to_insert = []
for image_path in tqdm(image_list, desc="ç”Ÿæˆå›¾åƒåµŒå…¥"):
    vector = encoder.encode_image(image_path)
    data_to_insert.append({"vector": vector, "image_path": image_path})

if data_to_insert:
    result = milvus_client.insert(collection_name=COLLECTION_NAME, data=data_to_insert)
    print(f"æˆåŠŸæ’å…¥ {result['insert_count']} æ¡æ•°æ®ã€‚")
```

### 4.4 åˆ›å»ºç´¢å¼•

ä¸ºäº†å®ç°å¿«é€Ÿæ£€ç´¢ï¼Œéœ€è¦ä¸ºå‘é‡å­—æ®µåˆ›å»ºç´¢å¼•ã€‚è¿™é‡Œé€‰æ‹© `HNSW` ç´¢å¼•ï¼Œå®ƒåœ¨å¬å›ç‡å’ŒæŸ¥è¯¢æ€§èƒ½ä¹‹é—´æœ‰ç€å¾ˆå¥½çš„å¹³è¡¡ã€‚åˆ›å»ºç´¢å¼•åï¼Œå¿…é¡»è°ƒç”¨ `load_collection` å°†é›†åˆåŠ è½½åˆ°å†…å­˜ä¸­æ‰èƒ½è¿›è¡Œæœç´¢ã€‚

```python
# 6. åˆ›å»ºç´¢å¼•
print(f"\n--> æ­£åœ¨ä¸º '{COLLECTION_NAME}' åˆ›å»ºç´¢å¼•")
index_params = milvus_client.prepare_index_params()
index_params.add_index(
    field_name="vector",
    index_type="HNSW",
    metric_type="COSINE",
    params={"M": 16, "efConstruction": 256}
)
milvus_client.create_index(collection_name=COLLECTION_NAME, index_params=index_params)
print("æˆåŠŸä¸ºå‘é‡å­—æ®µåˆ›å»º HNSW ç´¢å¼•ã€‚")
print("ç´¢å¼•è¯¦æƒ…:")
print(milvus_client.describe_index(collection_name=COLLECTION_NAME, index_name="vector"))
milvus_client.load_collection(collection_name=COLLECTION_NAME)
print("å·²åŠ è½½ Collection åˆ°å†…å­˜ä¸­ã€‚")
```

**è¾“å‡ºç»“æœï¼š**
```bash
--> æ­£åœ¨ä¸º 'multimodal_demo' åˆ›å»ºç´¢å¼•
æˆåŠŸä¸ºå‘é‡å­—æ®µåˆ›å»º HNSW ç´¢å¼•ã€‚
ç´¢å¼•è¯¦æƒ…:
{'M': '16', 'efConstruction': '256', 'metric_type': 'COSINE', 'index_type': 'HNSW', 'field_name': 'vector', 'index_name': 'vector', 'total_rows': 0, 'indexed_rows': 0, 'pending_index_rows': 0, 'state': 'Finished'}
å·²åŠ è½½ Collection åˆ°å†…å­˜ä¸­ã€‚
```

å¯ä»¥çœ‹å‡ºï¼Œç´¢å¼•åˆ›å»ºæˆåŠŸï¼Œåœ¨ `vector` å­—æ®µä¸ŠæˆåŠŸåˆ›å»ºäº† `HNSW` ç´¢å¼•ï¼Œå¹¶ä½¿ç”¨ `COSINE` ä½œä¸ºè·ç¦»åº¦é‡ã€‚`M: '16'` å’Œ `efConstruction: '256'` æ˜¯ HNSW ç´¢å¼•çš„ä¸¤ä¸ªå…³é”®å‚æ•°ï¼Œåˆ†åˆ«æ§åˆ¶ç€å›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§è¿æ¥æ•°å’Œç´¢å¼•æ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼Œè¿™äº›å‚æ•°ç›´æ¥å½±å“æ£€ç´¢çš„æ€§èƒ½å’Œå‡†ç¡®æ€§ã€‚`state: 'Finished'` çŠ¶æ€è¡¨æ˜ç´¢å¼•å·²æˆåŠŸæ„å»ºã€‚

### 4.5 æ‰§è¡Œå¤šæ¨¡æ€æ£€ç´¢

è¿™é‡Œé€šè¿‡å®šä¹‰ä¸€ä¸ªåŒ…å«å›¾ç‰‡å’Œæ–‡æœ¬çš„ç»„åˆæŸ¥è¯¢ï¼Œå°†å…¶ç¼–ç ä¸ºæŸ¥è¯¢å‘é‡ï¼Œç„¶åè°ƒç”¨ `search` æ–¹æ³•åœ¨ Milvus ä¸­æ‰§è¡Œè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ã€‚

```python
# 7. æ‰§è¡Œå¤šæ¨¡æ€æ£€ç´¢
print(f"\n--> æ­£åœ¨ '{COLLECTION_NAME}' ä¸­æ‰§è¡Œæ£€ç´¢")
query_image_path = os.path.join(DATA_DIR, "dragon", "query.png")
query_text = "ä¸€æ¡é¾™"
query_vector = encoder.encode_query(image_path=query_image_path, text=query_text)

search_results = milvus_client.search(
    collection_name=COLLECTION_NAME,
    data=[query_vector],
    output_fields=["image_path"],
    limit=5,
    search_params={"metric_type": "COSINE", "params": {"ef": 128}}
)[0]

retrieved_images = []
print("æ£€ç´¢ç»“æœ:")
for i, hit in enumerate(search_results):
    print(f"  Top {i+1}: ID={hit['id']}, è·ç¦»={hit['distance']:.4f}, è·¯å¾„='{hit['entity']['image_path']}'")
    retrieved_images.append(hit['entity']['image_path'])
```

**è¾“å‡ºç»“æœï¼š**

```bash
--> æ­£åœ¨ 'multimodal_demo' ä¸­æ‰§è¡Œæ£€ç´¢
æ£€ç´¢ç»“æœ:
  Top 1: ID=459243798403756667, è·ç¦»=0.9411, è·¯å¾„='../../data/C3\dragon\dragon01.png'
  Top 2: ID=459243798403756668, è·ç¦»=0.5818, è·¯å¾„='../../data/C3\dragon\dragon02.png'
  Top 3: ID=459243798403756671, è·ç¦»=0.5731, è·¯å¾„='../../data/C3\dragon\dragon05.png'
  Top 4: ID=459243798403756670, è·ç¦»=0.4894, è·¯å¾„='../../data/C3\dragon\dragon04.png'
  Top 5: ID=459243798403756669, è·ç¦»=0.4100, è·¯å¾„='../../data/C3\dragon\dragon03.png'
```

è¿™æ®µè¾“å‡ºå±•ç¤ºäº†ä¸å›¾æ–‡ç»„åˆæŸ¥è¯¢æœ€ç›¸ä¼¼çš„5ä¸ª**å®ä½“ (Entity)**ã€‚`distance` å­—æ®µä»£è¡¨äº†**ä½™å¼¦ç›¸ä¼¼åº¦**ï¼Œå€¼è¶Šæ¥è¿‘ 1 è¡¨ç¤ºè¶Šç›¸ä¼¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ`Top 1` ç»“æœæ­£æ˜¯æŸ¥è¯¢å›¾ç‰‡æœ¬èº«ï¼Œå…¶ç›¸ä¼¼åº¦å¾—åˆ†æœ€é«˜ï¼ˆ0.9411ï¼‰ï¼Œè¿™è¯´æ˜äº†æ£€ç´¢çš„æœ‰æ•ˆæ€§ã€‚å…¶ä½™ç»“æœä¹Ÿéƒ½æ˜¯é¾™çš„å›¾ç‰‡ï¼Œå¹¶æŒ‰ç›¸ä¼¼åº¦ä»é«˜åˆ°ä½ç²¾ç¡®æ’åˆ—ã€‚

### 4.6 å¯è§†åŒ–ä¸æ¸…ç†

æœ€åï¼Œå°†æ£€ç´¢åˆ°çš„å›¾ç‰‡è·¯å¾„ç”¨äºå¯è§†åŒ–ï¼Œç”Ÿæˆä¸€å¼ ç›´è§‚çš„ç»“æœå¯¹æ¯”å›¾ã€‚åœ¨å®Œæˆæ‰€æœ‰æ“ä½œåï¼Œåº”è¯¥é‡Šæ”¾ Milvus ä¸­çš„èµ„æºï¼ŒåŒ…æ‹¬ä»å†…å­˜ä¸­å¸è½½ Collection å’Œåˆ é™¤æ•´ä¸ª Collectionã€‚

```python
# 8. å¯è§†åŒ–ä¸æ¸…ç†
print(f"\n--> æ­£åœ¨å¯è§†åŒ–ç»“æœå¹¶æ¸…ç†èµ„æº")
if not retrieved_images:
    print("æ²¡æœ‰æ£€ç´¢åˆ°ä»»ä½•å›¾åƒã€‚")
else:
    panoramic_image = visualize_results(query_image_path, retrieved_images)
    combined_image_path = os.path.join(DATA_DIR, "search_result.png")
    cv2.imwrite(combined_image_path, panoramic_image)
    print(f"ç»“æœå›¾åƒå·²ä¿å­˜åˆ°: {combined_image_path}")
    Image.open(combined_image_path).show()

milvus_client.release_collection(collection_name=COLLECTION_NAME)
print(f"å·²ä»å†…å­˜ä¸­é‡Šæ”¾ Collection: '{COLLECTION_NAME}'")
milvus_client.drop_collection(COLLECTION_NAME)
print(f"å·²åˆ é™¤ Collection: '{COLLECTION_NAME}'")
```

![æ£€ç´¢ç»“æœå¯è§†åŒ–](./images/3_4_3.png)

é€šè¿‡ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå¤šæ¨¡æ€æ£€ç´¢å¼•æ“æˆåŠŸåœ°ç†è§£äº†â€œä¸€æ¡é¾™â€è¿™ä¸ªå›¾æ–‡ç»„åˆæŸ¥è¯¢çš„æ„å›¾ï¼Œå¹¶ä»å›¾åº“ä¸­æ‰¾åˆ°äº†æœ€ç›¸å…³çš„å‡ å¼ å›¾ç‰‡å¹¶è¿›è¡Œæ’åºã€‚

> [æœ¬èŠ‚å®Œæ•´ä»£ç ](https://github.com/datawhalechina/all-in-rag/blob/main/code/C3/04_multi_milvus.py)
>
> # ğŸ‰ å¤šæ¨¡æ€å›¾æ–‡æ£€ç´¢ç³»ç»Ÿå…¨æµç¨‹å·¥ç¨‹æŒ‡å—

æœ¬æŒ‡å—æ¶µç›–äº†ä»ç¯å¢ƒæ­å»ºã€æ¨¡å‹æ¨ç†åˆ°å‘é‡æ£€ç´¢çš„å®Œæ•´å·¥ç¨‹é“¾è·¯ï¼Œæ—¨åœ¨æŒ‡å¯¼å¦‚ä½•æ„å»ºåŸºäº Milvus ä¸ Visualized BGE çš„å›¾æ–‡æ£€ç´¢ç³»ç»Ÿã€‚

---

## ä¸€ã€ ç³»ç»Ÿæ¶æ„å…¨ç”Ÿå‘½å‘¨æœŸ (Mermaid)

```mermaid
graph TD
    %% ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½
    subgraph Infrastructure [1. åŸºç¡€è®¾æ–½å±‚]
    Start[docker compose up -d] --> Milvus_Svr[Milvus Server è¿è¡Œ]
    Milvus_Svr --> Client_Conn[MilvusClient åˆå§‹åŒ–è¿æ¥]
    end

    %% ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®é¢„å¤„ç†
    subgraph Data_Preprocessing [2. æ•°æ®é¢„å¤„ç†å±‚]
    Load_Model[åŠ è½½ Visualized BGE æƒé‡] --> Glob_Img[æ‰«ææœ¬åœ°æ•°æ®é›† glob]
    Glob_Img --> Inference[æ¨¡å‹æ¨ç†: å›¾åƒ/æ–‡æœ¬è½¬å‘é‡]
    end

    %% ç¬¬ä¸‰é˜¶æ®µï¼šå‘é‡æ•°æ®åº“æ„å»º
    subgraph Milvus_Ops [3. å‘é‡æ•°æ®åº“æ„å»º]
    Schema[å®šä¹‰ Schema: ID/Vector/Path] --> Create_Coll[åˆ›å»º Collection]
    Create_Coll --> Insert_Data[æ‰¹é‡æ’å…¥æ•°æ® Insert]
    Insert_Data --> Build_Index[æ„å»º HNSW ç´¢å¼•]
    Build_Index --> Load_Mem[Load åŠ è½½è‡³å†…å­˜]
    end

    %% ç¬¬å››é˜¶æ®µï¼šæ£€ç´¢åº”ç”¨
    subgraph Search_Phase [4. æ£€ç´¢åº”ç”¨å±‚]
    Query_Input[ç”¨æˆ·è¾“å…¥: çº¯æ–‡/çº¯å›¾/æ··åˆ] --> Gen_Vec[ç”Ÿæˆ Query Vector]
    Gen_Vec --> Vector_Search[Milvus è¿‘é‚»æœç´¢]
    Vector_Search --> Results[è¿”å› Top-K å›¾ç‰‡è·¯å¾„]
    end

    %% è¿æ¥é€»è¾‘
    Client_Conn --> Load_Model
    Inference --> Schema
    Load_Mem --> Query_Input
